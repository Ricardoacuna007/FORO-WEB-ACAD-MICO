<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calendario académico del Foro Académico UPA. Visualiza eventos, exámenes, tareas y avisos importantes.">
    <title>Calendario - Foro Académico UPA</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FullCalendar se carga de forma diferida para optimizar el tiempo de carga -->
    <link rel="stylesheet" href="/FORO%20WEB%20ACAD%C3%89MICO/frontend/css/styles.css">
    
    <style>
        .fc {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .fc-event {
            border: none;
            padding: 2px 4px;
            cursor: pointer;
        }
        
        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-upa-primary sticky-top shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#" data-route="foro">
                <i class="fas fa-graduation-cap fa-2x me-2"></i>
                <span class="fw-bold d-none d-md-inline">Foro Académico UPA</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <div class="d-flex align-items-center ms-auto">
                    <div class="dropdown">
                        <button class="btn btn-link text-white d-flex align-items-center" data-bs-toggle="dropdown">
                            <img src="https://ui-avatars.com/api/?name=U&background=FF6600&color=fff" 
                                 class="rounded-circle me-2" width="35" height="35">
                            <span class="d-none d-md-inline">Usuario</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" data-route="foro"><i class="fas fa-fire me-2"></i> Foro</a></li>
                        <li><a class="dropdown-item" href="#" data-route="dashboard"><i class="fas fa-home me-2"></i> Dashboard</a></li>
                            <li><a class="dropdown-item" href="#" data-route="perfil"><i class="fas fa-user me-2"></i> Mi Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" data-action="logout">
                                <i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#" data-route="foro">Inicio</a></li>
                <li class="breadcrumb-item active">Calendario Académico</li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold">
                <i class="fas fa-calendar-alt me-2"></i> Calendario Académico
            </h2>
            <button class="btn btn-upa-primary" data-bs-toggle="modal" data-bs-target="#nuevoEventoModal" data-visible-for="profesor,admin">
                <i class="fas fa-plus me-2"></i> Nuevo Evento
            </button>
        </div>

        <div class="row">
            <!-- Calendario Principal -->
            <div class="col-lg-9">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <div id="calendar"></div>
                    </div>
                </div>

                <!-- Leyenda de Colores -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-palette me-2"></i> Categorías de Eventos
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #dc3545;"></div>
                                <span>Exámenes</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #ffc107;"></div>
                                <span>Entregas</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #0d6efd;"></div>
                                <span>Clases Especiales</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #198754;"></div>
                                <span>Eventos Institucionales</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #6f42c1;"></div>
                                <span>Otros</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar con Próximos Eventos -->
            <div class="col-lg-3">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-clock me-2"></i> Próximos Eventos
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="proximosEventosList">
                            <div class="text-center py-3 text-muted small">
                                Cargando eventos...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-filter me-2"></i> Filtrar por Materia
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="filtrosMaterias">
                            <div class="text-center py-3 text-muted small">
                                Cargando materias...
                            </div>
                        </div>
                        <hr>
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="exportarCalendario()">
                            <i class="fas fa-download me-2"></i> Exportar a Google Calendar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Evento -->
    <div class="modal fade" id="nuevoEventoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Nuevo Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="nuevoEventoForm">
                        <div class="mb-3">
                            <label class="form-label">Título del Evento *</label>
                            <input type="text" class="form-control" name="titulo" required>
                            <div class="invalid-feedback">Por favor ingresa un título</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categoría *</label>
                            <select class="form-select" name="categoria" required>
                                <option value="">Selecciona</option>
                                <option value="examen">Examen</option>
                                <option value="tarea">Tarea</option>
                                <option value="evento">Evento</option>
                                <option value="aviso">Aviso</option>
                            </select>
                            <div class="invalid-feedback">Por favor selecciona una categoría</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Materia</label>
                            <select class="form-select" name="materia">
                                <option value="">Selecciona (opcional)</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Inicio *</label>
                                <input type="date" class="form-control" name="fechaInicio" required>
                                <div class="invalid-feedback">Por favor selecciona una fecha</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hora Inicio</label>
                                <input type="time" class="form-control" name="horaInicio">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Fecha Fin</label>
                                <input type="date" class="form-control" name="fechaFin">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Hora Fin</label>
                                <input type="time" class="form-control" name="horaFin">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control" rows="3" name="descripcion"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-upa-primary" form="nuevoEventoForm">Crear Evento</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ver Evento -->
    <div class="modal fade" id="verEventoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="eventoTitulo">Detalle del evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <span class="badge mb-2" id="eventoCategoriaBadge">Categoría</span>
                        <p class="mb-2">
                            <i class="fas fa-calendar me-2"></i>
                            <strong id="eventoFecha">Fecha</strong>
                        </p>
                        <p class="mb-2">
                            <i class="fas fa-clock me-2"></i>
                            <span id="eventoHorario">Horario</span>
                        </p>
                        <p class="mb-2" id="eventoMateriaWrapper" style="display: none;">
                            <i class="fas fa-book me-2"></i>
                            <span id="eventoMateria">Materia</span>
                        </p>
                        <p class="mb-2" id="eventoCarreraWrapper" style="display: none;">
                            <i class="fas fa-graduation-cap me-2"></i>
                            <span id="eventoCarrera">Carrera</span>
                        </p>
                        <p class="mb-2" id="eventoCreadorWrapper" style="display: none;">
                            <i class="fas fa-user me-2"></i>
                            <span id="eventoCreador">Creado por</span>
                        </p>
                    </div>
                    <div class="alert alert-info mb-0" id="eventoDescripcionWrapper">
                        <strong>Descripción:</strong><br>
                        <span id="eventoDescripcion">Sin descripción disponible.</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <a href="#" class="btn btn-outline-success" id="btnGoogleCalendar" target="_blank" rel="noopener">
                        <i class="fab fa-google me-2"></i> Añadir a Google Calendar
                    </a>
                    <button type="button" class="btn btn-outline-primary">
                        <i class="fas fa-edit me-2"></i> Editar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar se carga de forma diferida -->
    <script src="/FORO%20WEB%20ACAD%C3%89MICO/frontend/js/api.js"></script>
    <script src="/FORO%20WEB%20ACAD%C3%89MICO/frontend/js/auth.js"></script>
    <script src="/FORO%20WEB%20ACAD%C3%89MICO/frontend/js/calendario.js"></script>
    <script src="/FORO%20WEB%20ACAD%C3%89MICO/frontend/js/main.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Inicializar calendario
            inicializarCalendario();
            
            // Cargar materias para el formulario
            await cargarMaterias();
            
            // Configurar formulario de nuevo evento
            const formNuevoEvento = document.getElementById('nuevoEventoForm');
            if (formNuevoEvento) {
                formNuevoEvento.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(formNuevoEvento);
                    const datosEvento = {
                        titulo: formData.get('titulo'),
                        categoria: formData.get('categoria'),
                        materia_id: formData.get('materia') || null,
                        fechaInicio: formData.get('fechaInicio'),
                        horaInicio: formData.get('horaInicio') || '00:00:00',
                        fechaFin: formData.get('fechaFin') || null,
                        horaFin: formData.get('horaFin') || null,
                        descripcion: formData.get('descripcion') || ''
                    };
                    
                    if (await crearEvento(datosEvento)) {
                        formNuevoEvento.reset();
                    }
                });
            }
        });
        
        // Función para exportar calendario
        function exportarCalendario() {
            // TODO: Implementar exportación a Google Calendar
            mostrarNotificacion('info', 'Funcionalidad de exportación en desarrollo');
        }
        
        // Cargar materias para el select y filtros
        async function cargarMaterias() {
            try {
                const response = await API.getMaterias();
                if (response.success && response.data) {
                    // Cargar en el select del formulario
                    const selectMateria = document.querySelector('#nuevoEventoModal select[name="materia"]');
                    if (selectMateria) {
                        selectMateria.innerHTML = '<option value="">Selecciona (opcional)</option>';
                        response.data.forEach(materia => {
                            const option = document.createElement('option');
                            option.value = materia.id;
                            option.textContent = materia.nombre;
                            selectMateria.appendChild(option);
                        });
                    }
                    
                    // Cargar en los filtros
                    const filtrosMaterias = document.getElementById('filtrosMaterias');
                    if (filtrosMaterias && response.data.length > 0) {
                        filtrosMaterias.innerHTML = '';
                        response.data.forEach(materia => {
                            const div = document.createElement('div');
                            div.className = 'form-check mb-2';
                            div.innerHTML = `
                                <input class="form-check-input materia-filter" type="checkbox" 
                                       id="materia-${materia.id}" value="${materia.id}" checked
                                       onchange="filtrarEventosPorMateria()">
                                <label class="form-check-label" for="materia-${materia.id}">
                                    ${materia.nombre}
                                </label>
                            `;
                            filtrosMaterias.appendChild(div);
                        });
                    } else if (filtrosMaterias) {
                        filtrosMaterias.innerHTML = '<div class="text-muted small">No hay materias disponibles</div>';
                    }
                }
            } catch (error) {
                console.error('Error al cargar materias:', error);
            }
        }
        
        // Filtrar eventos por materia
        function filtrarEventosPorMateria() {
            const materiasSeleccionadas = Array.from(document.querySelectorAll('.materia-filter:checked'))
                .map(cb => cb.value);
            
            if (materiasSeleccionadas.length === 0) {
                // Si no hay ninguna seleccionada, mostrar todas
                cargarEventos();
            } else {
                // Filtrar eventos por materias seleccionadas
                cargarEventos({ materia_id: materiasSeleccionadas.join(',') });
            }
        }
        
    </script>
</body>
</html>