<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Materia Bases de Datos - Foro Académico UPA. Publicaciones, dudas y recursos sobre Bases de Datos.">
    <title>Bases de Datos - Foro Académico UPA</title>
    
    <!-- Preconnect para CDNs (mejora el rendimiento) -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css?v=20251116">
    
    <style>
        .filter-pills .btn-check:checked + .btn {
            background-color: #003366;
            border-color: #003366;
            color: white;
        }
        
        .post-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .post-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left-color: #003366;
        }
        
        .category-badge-duda { background-color: #0d6efd; }
        .category-badge-recurso { background-color: #198754; }
        .category-badge-aviso { background-color: #ffc107; color: #000; }
        .category-badge-discusion { background-color: #6f42c1; }
    </style>
</head>
<body>
    <!-- Navbar (igual que dashboard) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-upa-primary sticky-top shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#" data-route="dashboard">
                <i class="fas fa-graduation-cap fa-2x me-2"></i>
                <span class="fw-bold d-none d-md-inline">Foro Académico UPA</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarContent">
                <form class="d-flex mx-auto col-lg-4 my-2 my-lg-0" role="search" onsubmit="event.preventDefault(); buscarEnMateria();">
                    <div class="input-group search-container">
                        <input class="form-control" type="search" id="searchInput" placeholder="Buscar en esta materia..." aria-label="Buscar">
                        <button class="btn btn-light" type="submit" aria-label="Buscar"><i class="fas fa-search"></i></button>
                    </div>
                </form>

                <div class="d-flex align-items-center ms-auto">
                    <div class="dropdown me-3">
                        <button class="btn btn-link text-white position-relative" type="button" id="notificacionesDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-bell fa-lg"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" style="min-width: 320px; max-height: 400px; overflow-y: auto;">
                            <li class="dropdown-header d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Notificaciones</span>
                                <a href="#" class="text-decoration-none small" onclick="marcarTodasLeidas(); return false;">Marcar todas como leídas</a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="text-center py-2">
                                <a href="#" data-route="notificaciones" class="text-decoration-none small">Ver todas las notificaciones</a>
                            </li>
                        </ul>
                    </div>

                    <div class="dropdown">
                        <button class="btn btn-link text-white d-flex align-items-center" data-bs-toggle="dropdown">
                            <img src="https://ui-avatars.com/api/?name=U&background=FF6600&color=fff" 
                                 class="rounded-circle me-2" width="35" height="35" alt="Avatar de usuario" id="navbarAvatar">
                            <span class="d-none d-md-inline" id="nombreUsuario">Usuario</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" data-route="perfil"><i class="fas fa-user me-2"></i> Mi Perfil</a></li>
                            <li><a class="dropdown-item" href="#" data-route="dashboard"><i class="fas fa-home me-2"></i> Dashboard</a></li>
                            <li><a class="dropdown-item" href="#" data-route="calendario"><i class="fas fa-calendar me-2"></i> Calendario</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" data-action="logout">
                                <i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="min-height: calc(100vh - 56px);">
                <div class="position-sticky pt-3">
                    <a href="#" data-route="dashboard" class="btn btn-outline-primary w-100 mb-3">
                        <i class="fas fa-arrow-left me-2"></i> Volver al Dashboard
                    </a>
                    
                    <h2 class="h6 text-muted text-uppercase small px-3 mb-2">Navegación</h2>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-route="carrera">
                                <i class="fas fa-laptop-code me-2"></i> ISC
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link ms-3" href="#" data-route="cuatrimestre">
                                <i class="fas fa-folder me-2"></i> 7° Cuatrimestre
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active ms-4" href="#">
                                <i class="fas fa-book me-2"></i> Bases de Datos
                            </a>
                        </li>
                    </ul>

                    <h2 class="h6 text-muted text-uppercase small px-3 mt-4 mb-2">Otras Materias</h2>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link ms-4 small" href="#" data-route="materia?id=2">
                                <i class="fas fa-book me-2"></i> Programación Web
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link ms-4 small" href="#" data-route="materia?id=3">
                                <i class="fas fa-book me-2"></i> Redes
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Contenido Principal -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4" id="materiaMain">
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#" data-route="dashboard">Inicio</a></li>
                        <li class="breadcrumb-item"><a href="#" id="breadcrumbCarrera">Carrera</a></li>
                        <li class="breadcrumb-item"><span id="breadcrumbCuatrimestre">Cuatrimestre</span></li>
                        <li class="breadcrumb-item active" id="breadcrumbMateria">Materia</li>
                    </ol>
                </nav>

                <!-- Header de Materia -->
                <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #003366 0%, #004488 100%);">
                    <div class="card-body text-white p-4">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h2 class="fw-bold mb-2" id="materiaNombre">
                                    <i class="fas fa-book me-2"></i> Cargando...
                                </h2>
                                <p class="mb-2" id="materiaInfo">
                                    <i class="fas fa-user me-2"></i> Cargando... • 
                                    <i class="fas fa-users me-2"></i> <span id="estudiantesCount">-</span> estudiantes
                                </p>
                                <p class="mb-0 small opacity-75" id="materiaDescripcion">
                                    Cargando descripción...
                                </p>
                            </div>
                            <button class="btn btn-light btn-lg" data-bs-toggle="modal" data-bs-target="#crearPostModal">
                                <i class="fas fa-plus me-2"></i> Nueva Publicación
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas Rápidas -->
                <div class="row g-3 mb-4" id="estadisticasMateria">
                    <!-- Las estadísticas se cargarán dinámicamente -->
                </div>

                <!-- Filtros por Categoría -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="filter-pills btn-group" role="group" id="filtrosCategoria">
                                <input type="radio" class="btn-check" name="categoria" id="todas" value="todas" checked onchange="filtrarPublicaciones('todas')">
                                <label class="btn btn-outline-primary" for="todas">
                                    <i class="fas fa-list me-1"></i> Todas (<span id="countTodas">0</span>)
                                </label>

                                <input type="radio" class="btn-check" name="categoria" id="dudas" value="duda" onchange="filtrarPublicaciones('duda')">
                                <label class="btn btn-outline-primary" for="dudas">
                                    <i class="fas fa-question-circle me-1"></i> Dudas (<span id="countDudas">0</span>)
                                </label>

                                <input type="radio" class="btn-check" name="categoria" id="recursos" value="recurso" onchange="filtrarPublicaciones('recurso')">
                                <label class="btn btn-outline-primary" for="recursos">
                                    <i class="fas fa-book me-1"></i> Recursos (<span id="countRecursos">0</span>)
                                </label>

                                <input type="radio" class="btn-check" name="categoria" id="avisos" value="aviso" onchange="filtrarPublicaciones('aviso')">
                                <label class="btn btn-outline-primary" for="avisos">
                                    <i class="fas fa-bullhorn me-1"></i> Avisos (<span id="countAvisos">0</span>)
                                </label>

                                <input type="radio" class="btn-check" name="categoria" id="discusiones" value="discusion" onchange="filtrarPublicaciones('discusion')">
                                <label class="btn btn-outline-primary" for="discusiones">
                                    <i class="fas fa-comments me-1"></i> Discusiones (<span id="countDiscusiones">0</span>)
                                </label>
                            </div>

                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-sort me-2"></i> Ordenar por
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="ordenarPublicaciones('reciente')">Más recientes</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="ordenarPublicaciones('popular')">Más populares</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="ordenarPublicaciones('sin_responder')">Sin responder</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de Publicaciones -->
                <div id="publicacionesContainer" style="min-height: 200px;">
                    <!-- Las publicaciones se cargarán dinámicamente mediante posts.js -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando publicaciones...</span>
                        </div>
                        <p class="text-muted mt-3">Cargando publicaciones...</p>
                    </div>
                </div>

                <!-- Paginación -->
                <nav aria-label="Paginación" id="paginacionContainer" style="display: none;">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- La paginación se generará dinámicamente -->
                    </ul>
                </nav>
            </main>
        </div>
    </div>

    <!-- Modal Crear Publicación -->
    <div class="modal fade" id="crearPostModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="crearPostModalTitulo">
                        <i class="fas fa-edit me-2"></i> Nueva Publicación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="crearPostForm">
                        <div class="mb-3">
                            <label class="form-label">Categoría *</label>
                            <select class="form-select" id="postCategoria" name="categoria" required>
                                <option value="">Selecciona una categoría</option>
                                <option value="duda">Duda</option>
                                <option value="recurso">Recurso</option>
                                <option value="aviso">Aviso</option>
                                <option value="discusion">Discusión</option>
                            </select>
                            <div class="invalid-feedback">Debes seleccionar una categoría</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Título *</label>
                            <input type="text" class="form-control" id="postTitulo" name="titulo" placeholder="Describe tu publicación" required minlength="5" maxlength="200">
                            <div class="invalid-feedback">El título debe tener entre 5 y 200 caracteres</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Contenido *</label>
                            <textarea class="form-control" id="postContenido" name="contenido" rows="6" placeholder="Describe tu duda, comparte recursos..." required minlength="10" maxlength="5000"></textarea>
                            <div class="invalid-feedback">El contenido debe tener entre 10 y 5000 caracteres</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Archivos (opcional)</label>
                            <input type="file" class="form-control" id="postArchivos" name="archivos" multiple onchange="manejarSeleccionArchivos(this)">
                            <small class="text-muted">Máximo 50MB por archivo. Formatos: PDF, DOC, DOCX, TXT, JPG, PNG, ZIP, RAR, PPTX, XLSX</small>
                            <div id="archivosSeleccionados" class="mt-2"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Etiquetas (opcional)</label>
                            <input type="text" class="form-control" id="postEtiquetas" name="etiquetas" placeholder="Ej: sql, normalización, 3FN">
                            <small class="text-muted">Separa las etiquetas con comas</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-upa-primary" onclick="enviarNuevaPublicacion()">
                        <i class="fas fa-paper-plane me-2"></i> Publicar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Publicación -->
    <div class="modal fade" id="editarPostModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-edit me-2"></i> Editar Publicación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editarPostForm" onsubmit="event.preventDefault(); guardarEdicionPublicacion();">
                        <div class="mb-3">
                            <label class="form-label">Categoría *</label>
                            <select class="form-select" id="editPostCategoria" name="categoria" required>
                                <option value="">Selecciona una categoría</option>
                                <option value="duda">Duda</option>
                                <option value="recurso">Recurso</option>
                                <option value="aviso">Aviso</option>
                                <option value="discusion">Discusión</option>
                            </select>
                            <div class="invalid-feedback">Debes seleccionar una categoría</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Título *</label>
                            <input type="text" class="form-control" id="editPostTitulo" name="titulo" required minlength="5" maxlength="200">
                            <div class="invalid-feedback">El título debe tener entre 5 y 200 caracteres</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Contenido *</label>
                            <textarea class="form-control" id="editPostContenido" name="contenido" rows="6" required minlength="10" maxlength="5000"></textarea>
                            <div class="invalid-feedback">El contenido debe tener entre 10 y 5000 caracteres</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Etiquetas (separadas por comas)</label>
                            <input type="text" class="form-control" id="editPostEtiquetas" name="etiquetas" placeholder="ej: laravel, php, backend">
                            <small class="text-muted">Separa las etiquetas con comas</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-upa-primary" form="editarPostForm">
                        <i class="fas fa-save me-2"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Scripts principales -->
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/validation.js"></script>
    
    <!-- Scripts específicos -->
    <script src="/js/posts.js"></script>
    <script src="/js/search.js"></script>
    <script src="/js/notifications.js"></script>
    
    <script>
        // Variables globales
        let materiaId = null;
        let filtroCategoriaActual = 'todas';
        let ordenActual = 'reciente';
        
        // Obtener ID de materia de la URL
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            materiaId = urlParams.get('id');

            if (!materiaId) {
                mostrarAccesoRestringido('No se especificó la materia que deseas consultar.');
                return;
            }
            
            // Cargar información de la materia
            const informacionDisponible = await cargarInformacionMateria(materiaId);
            if (!informacionDisponible) {
                return;
            }
            
            // Cargar publicaciones
            await cargarPublicaciones(materiaId, filtroCategoriaActual, ordenActual);
            
            // Inicializar búsqueda
            if (typeof inicializarBusqueda === 'function') {
                inicializarBusqueda();
            }
            
            // Inicializar validación del formulario
            const form = document.getElementById('crearPostForm');
            if (form && typeof inicializarValidacionTiempoReal === 'function') {
                inicializarValidacionTiempoReal(form, {
                    categoria: { requerido: true },
                    titulo: { requerido: true, minLength: 5, maxLength: 200 },
                    contenido: { requerido: true, minLength: 10, maxLength: 5000 }
                });
            }
        });
        
        // Cargar información de la materia
        async function cargarInformacionMateria(id) {
            try {
                const response = await API.getMateria(id);
                
                if (!response.success || !response.data) {
                    throw new Error(response.message || 'No se pudo cargar la información de la materia');
                }

                const materia = response.data;

                // Actualizar UI
                document.getElementById('materiaNombre').innerHTML = `<i class="fas fa-book me-2"></i> ${materia.nombre}`;
                document.getElementById('materiaInfo').innerHTML = `
                        <i class="fas fa-user me-2"></i> ${materia.profesor?.nombre || 'Sin profesor asignado'} • 
                        <i class="fas fa-users me-2"></i> <span id="estudiantesCount">${materia.estudiantes_count || 0}</span> estudiantes
                    `;
                document.getElementById('materiaDescripcion').textContent = materia.descripcion || '';
                actualizarBreadcrumbsMateria(materia);
                actualizarTituloModalMateria(materia);
                
                // Actualizar estadísticas
                actualizarEstadisticasMateria(materia);
                return true;
                
            } catch (error) {
                console.error('Error al cargar información de la materia:', error);
                const mensaje = error.message || 'No se pudo cargar la información de la materia';
                mostrarAccesoRestringido(mensaje);
                if (typeof mostrarNotificacion === 'function') {
                    mostrarNotificacion('error', mensaje);
                }
                return false;
            }

            return true;
        }

        function actualizarBreadcrumbsMateria(materia) {
            const carreraEnlace = document.getElementById('breadcrumbCarrera');
            if (carreraEnlace && materia.carrera) {
                const relativeRoute = `carrera?id=${materia.carrera.id}`;
                carreraEnlace.textContent = materia.carrera.nombre;
                carreraEnlace.setAttribute('data-route', relativeRoute);
                const carreraUrl = typeof buildFrontendUrl === 'function'
                    ? buildFrontendUrl(relativeRoute)
                    : `views/carrera.html?id=${materia.carrera.id}`;
                carreraEnlace.setAttribute('href', carreraUrl);
            }

            const cuatrimestreElemento = document.getElementById('breadcrumbCuatrimestre');
            if (cuatrimestreElemento) {
                const numero = materia.cuatrimestre?.numero;
                cuatrimestreElemento.textContent = numero ? `${numero}° Cuatrimestre` : 'Cuatrimestre';
            }

            const materiaElemento = document.getElementById('breadcrumbMateria');
            if (materiaElemento) {
                materiaElemento.textContent = materia.nombre || 'Materia';
            }
        }

        function actualizarTituloModalMateria(materia) {
            const tituloModal = document.getElementById('crearPostModalTitulo');
            if (tituloModal) {
                tituloModal.innerHTML = `<i class="fas fa-edit me-2"></i> Nueva Publicación en ${materia.nombre || 'la materia'}`;
            }

            const botonNuevaPublicacion = document.querySelector('[data-bs-target="#crearPostModal"]');
            if (botonNuevaPublicacion && materia?.carrera?.id) {
                botonNuevaPublicacion.classList.remove('d-none');
            }
        }
        
        // Actualizar estadísticas de la materia
        function actualizarEstadisticasMateria(materia) {
            const stats = materia.publicaciones_por_categoria || {};
            const total = materia.publicaciones_count || 0;
            
            document.getElementById('estadisticasMateria').innerHTML = `
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body">
                            <i class="fas fa-comments fa-2x text-primary mb-2"></i>
                            <h4 class="fw-bold mb-0">${total}</h4>
                            <small class="text-muted">Publicaciones</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body">
                            <i class="fas fa-question-circle fa-2x text-info mb-2"></i>
                            <h4 class="fw-bold mb-0">${stats.duda || 0}</h4>
                            <small class="text-muted">Dudas Activas</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body">
                            <i class="fas fa-file-alt fa-2x text-success mb-2"></i>
                            <h4 class="fw-bold mb-0">${stats.recurso || 0}</h4>
                            <small class="text-muted">Recursos</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body">
                            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                            <h4 class="fw-bold mb-0">-</h4>
                            <small class="text-muted">Esta Semana</small>
                        </div>
                    </div>
                </div>
            `;
        }

        function mostrarAccesoRestringido(mensaje) {
            const main = document.getElementById('materiaMain');
            if (!main) return;

            const destinoDashboard = typeof buildFrontendUrl === 'function'
                ? buildFrontendUrl('dashboard')
                : '#';

            main.innerHTML = `
                <div class="d-flex align-items-center justify-content-center" style="min-height: 60vh;">
                    <div class="text-center">
                        <i class="fas fa-lock fa-3x text-danger mb-3"></i>
                        <h2 class="fw-bold mb-2">Acceso restringido</h2>
                        <p class="text-muted mb-4">${mensaje}</p>
                        <a href="${destinoDashboard}" data-route="dashboard" class="btn btn-upa-primary">
                            <i class="fas fa-arrow-left me-2"></i> Volver al dashboard
                        </a>
                    </div>
                </div>
            `;

            const botonNuevaPublicacion = document.querySelector('[data-bs-target="#crearPostModal"]');
            if (botonNuevaPublicacion) {
                botonNuevaPublicacion.classList.add('d-none');
            }
        }
        
        // Filtrar publicaciones por categoría
        function filtrarPublicaciones(categoria) {
            filtroCategoriaActual = categoria;
            cargarPublicaciones(materiaId, categoria, ordenActual);
        }
        
        // Ordenar publicaciones
        function ordenarPublicaciones(orden) {
            ordenActual = orden;
            cargarPublicaciones(materiaId, filtroCategoriaActual, orden);
        }
        
        // Buscar en la materia
        function buscarEnMateria() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length >= 3) {
                if (typeof realizarBusqueda === 'function') {
                    realizarBusqueda(query);
                } else {
                    // Búsqueda simple en las publicaciones actuales
                    const resultados = publicaciones.filter(p => 
                        p.titulo.toLowerCase().includes(query.toLowerCase()) ||
                        p.contenido.toLowerCase().includes(query.toLowerCase())
                    );
                    publicaciones = resultados;
                    renderizarPublicaciones();
                }
            } else if (query.length === 0) {
                // Recargar todas las publicaciones si se limpia la búsqueda
                cargarPublicaciones(materiaId, filtroCategoriaActual, ordenActual);
            }
        }
        
        // Enviar nueva publicación
        async function enviarNuevaPublicacion() {
            const form = document.getElementById('crearPostForm');
            
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            
            const datosPublicacion = {
                titulo: document.getElementById('postTitulo').value.trim(),
                contenido: document.getElementById('postContenido').value.trim(),
                categoria: document.getElementById('postCategoria').value,
                materia_id: parseInt(materiaId),
                etiquetas: document.getElementById('postEtiquetas').value.split(',').map(t => t.trim()).filter(t => t)
            };
            
            if (await crearPublicacion(datosPublicacion)) {
                // Recargar publicaciones
                await cargarPublicaciones(materiaId, filtroCategoriaActual, ordenActual);
                // Recargar información de la materia para actualizar estadísticas
                await cargarInformacionMateria(materiaId);
            }
        }
        
        // Función auxiliar para manejar archivos seleccionados
        function manejarSeleccionArchivos(input) {
            if (typeof actualizarListaArchivos === 'function') {
                actualizarListaArchivos();
            }
        }
        
        // Actualizar contadores de categorías después de cargar publicaciones
        function actualizarContadoresCategorias() {
            if (typeof publicaciones === 'undefined' || !publicaciones) return;
            
            const contadores = {
                todas: publicaciones.length,
                duda: publicaciones.filter(p => p.categoria === 'duda').length,
                recurso: publicaciones.filter(p => p.categoria === 'recurso').length,
                aviso: publicaciones.filter(p => p.categoria === 'aviso').length,
                discusion: publicaciones.filter(p => p.categoria === 'discusion').length
            };
            
            if (document.getElementById('countTodas')) document.getElementById('countTodas').textContent = contadores.todas;
            if (document.getElementById('countDudas')) document.getElementById('countDudas').textContent = contadores.duda;
            if (document.getElementById('countRecursos')) document.getElementById('countRecursos').textContent = contadores.recurso;
            if (document.getElementById('countAvisos')) document.getElementById('countAvisos').textContent = contadores.aviso;
            if (document.getElementById('countDiscusiones')) document.getElementById('countDiscusiones').textContent = contadores.discusion;
        }
        
        // Interceptar renderizado de publicaciones para actualizar contadores
        const originalRenderizar = window.renderizarPublicaciones;
        window.renderizarPublicaciones = function() {
            if (originalRenderizar) originalRenderizar();
            setTimeout(actualizarContadoresCategorias, 100);
        };
    </script>

    <!-- Footer -->
    <footer class="footer-custom mt-auto">
        <div class="container">
            <div class="row g-4">
                <div class="col-lg-4 col-md-6">
                    <h5 class="fw-bold mb-3"><i class="fas fa-graduation-cap me-2"></i> Foro Académico UPA</h5>
                <div class="col-lg-2 col-md-6">
                    <h6 class="fw-bold mb-3">Enlaces Rápidos</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="#" data-route="foro" class="text-muted text-decoration-none"><i class="fas fa-fire me-2"></i> Foro</a></li>
                        <li class="mb-2"><a href="#" data-route="dashboard" class="text-muted text-decoration-none"><i class="fas fa-home me-2"></i> Dashboard</a></li>
                        <li class="mb-2"><a href="#" data-route="calendario" class="text-muted text-decoration-none"><i class="fas fa-calendar me-2"></i> Calendario</a></li>
                        <li class="mb-2"><a href="#" data-route="perfil" class="text-muted text-decoration-none"><i class="fas fa-user me-2"></i> Mi Perfil</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h6 class="fw-bold mb-3">Recursos</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="#" data-route="search" class="text-muted text-decoration-none"><i class="fas fa-search me-2"></i> Búsqueda</a></li>
                        <li class="mb-2"><a href="#" data-route="notificaciones" class="text-muted text-decoration-none"><i class="fas fa-bell me-2"></i> Notificaciones</a></li>
                        <li class="mb-2"><a href="#" data-route="crear-post" class="text-muted text-decoration-none"><i class="fas fa-edit me-2"></i> Crear Publicación</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h6 class="fw-bold mb-3">Contacto y Redes Sociales</h6>
                    <ul class="list-unstyled text-muted small mb-4">
                        <li class="mb-3"><a href="mailto:hacrikianoni.9000@gmail.com" class="text-muted text-decoration-none" title="Enviar correo"><i class="fas fa-envelope me-2"></i> hacrikianoni.9000@gmail.com</a></li>
                    </ul>
                    <div class="social-links">
                        <a href="https://www.facebook.com/ricardo.acuna.359778?locale=es_LA" target="_blank" rel="noopener noreferrer" class="text-white me-3" aria-label="Facebook" title="Facebook"><i class="fab fa-facebook-f fa-lg"></i></a>
                        <a href="https://www.instagram.com/ricardo_acunaalc/" target="_blank" rel="noopener noreferrer" class="text-white me-3" aria-label="Instagram" title="Instagram"><i class="fab fa-instagram fa-lg"></i></a>
                        <a href="mailto:hacrikianoni.9000@gmail.com" class="text-white" aria-label="Email" title="Enviar correo"><i class="fas fa-envelope fa-lg"></i></a>
                    </div>
                </div>
            </div>
            <hr class="my-4 border-secondary">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="text-muted small mb-0">© <span id="footerYear-materia">2025</span> Foro Académico UPA. Todos los derechos reservados.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <ul class="list-inline mb-0 small">
                        <li class="list-inline-item me-3"><a href="#" class="text-muted text-decoration-none" onclick="if(typeof mostrarNotificacion==='function'){mostrarNotificacion('info','Política de Privacidad en desarrollo');}return false;">Política de Privacidad</a></li>
                        <li class="list-inline-item"><a href="#" class="text-muted text-decoration-none" onclick="if(typeof mostrarNotificacion==='function'){mostrarNotificacion('info','Términos y Condiciones en desarrollo');}return false;">Términos y Condiciones</a></li>
                    </ul>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12 text-center">
                    <p class="text-muted small mb-0">Desarrollado con <i class="fas fa-heart text-danger"></i> por Ricardo Acuña <span class="d-none d-md-inline">• Ingeniería en Sistemas Computacionales</span></p>
                </div>
            </div>
        </div>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded',function(){const f=document.getElementById('footerYear-materia');if(f)f.textContent=new Date().getFullYear();});
    </script>
</body>
</html>